# Helm chart values
grafana:
  persistence:
    enabled: true
    size: 5Gi
    inMemory:
      enabled: false
prometheus:
  prometheusSpec:
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: gp2
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
  additionalServiceMonitors:
    - name: "istiod"
      additionalLabels:
        monitor: "istio-control-plane"
      jobLabel: "istio"
      selector:
        matchLabels:
          app: "istiod"
      namespaceSelector:
        matchNames:
          - "istio-system"
      endpoints:
      - port: "http-monitoring"  # Make sure this is the port exposed by your Istio services for monitoring.
        interval: "15s"
        path: "/metrics"  # Update if Istio exposes metrics on a different path.
        scheme: "http"
        tlsConfig:
          insecureSkipVerify: true
      targetLabels:
        - "app"
        - "release"
      podTargetLabels:
        - "app"
        - "release"

    - name: "istio-ingressgateway"
      jobLabel: "istio-ingressgateway"
      selector:
        matchLabels:
          istio: "ingressgateway"
      namespaceSelector:
        matchNames:
          - "istio-ingress"
      endpoints:
      - port: "15020"  # Make sure this is the port exposed by your Istio services for monitoring.
        path: "/stats/prometheus"  # Update if Istio exposes metrics on a different path.
        tlsConfig:
          insecureSkipVerify: true
        scheme: "http"

  additionalPodMonitors:
  - name: "istio-workload-metrics"
    additionalLabels:
      monitor: "istio-mesh"
    jobLabel: "envoy-stats"
    selector:
      matchLabels:
        # Your Istio-injected pods should have specific labels, adjust as necessary
        security.istio.io/tlsMode: "istio"
    namespaceSelector:
      matchNames:
        - "bff"
        - "content"
        - "notification"
        # Add all other namespaces where your Istio-injected pods reside
    podMetricsEndpoints:
      - port: "http-envoy-prom"  # Ensure this matches the port exposed by your Istio sidecars.
        interval: "15s"
        path: "/stats/prometheus"
        scheme: "http"
